# CD Workflow for Chore-Ganizer
# This workflow runs only on push to main branch

name: CD (Continuous Deployment)

# Triggers the workflow only on push to main branch
on:
  push:
    branches: ['main']
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      deploy_to_server:
        description: 'Deploy to production server?'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

# Set up the environment
env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  # Will be set dynamically from github context
  IMAGE_NAME: ''

# Define the jobs to run
jobs:
  # Job 1: Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      # Step 1: Checkout the code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Step 3: Log in to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # Step 4: Extract metadata for Docker images
      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/chore-ganizer-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
      
      # Step 5: Build and push backend Docker image
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: dev/chore-ganizer/backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # Step 6: Extract metadata for frontend
      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/chore-ganizer-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
      
      # Step 7: Build and push frontend Docker image
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: dev/chore-ganizer/frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # Step 8: Create deployment summary
      - name: Create Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Built:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ steps.meta-backend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ steps.meta-frontend.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy manually, update your server's docker-compose.yml to use these images." >> $GITHUB_STEP_SUMMARY

  # Job 2: Deploy to Server (Optional - requires SSH or webhook configuration)
  deploy-to-server:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_server == 'yes'
    
    steps:
      # Step 1: Checkout repository for deployment scripts
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Deploy via SSH (Example - customize for your server)
      # Uncomment and configure if you have SSH access to your server
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd /path/to/chore-ganizer
      #       docker-compose pull
      #       docker-compose up -d
      
      # Step 3: OR Deploy via Webhook (Example)
      # Uncomment and configure if you have a deployment webhook
      # - name: Trigger Deployment Webhook
      #   run: |
      #     curl -X POST ${{ secrets.DEPLOY_WEBHOOK_URL }}
      
      # Step 4: Show deployment instructions
      - name: Show Deployment Instructions
        run: |
          echo "## Deployment Instructions ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To complete deployment, update your server:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update docker-compose.yml with new image tags" >> $GITHUB_STEP_SUMMARY
          echo "2. Run: `docker-compose pull`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run: `docker-compose up -d`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or configure SSH/webhook deployment in the workflow." >> $GITHUB_STEP_SUMMARY
